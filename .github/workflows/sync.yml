name: sync

on:
  workflow_dispatch:
    inputs:
      epic_branch:
        description: Name of original base branch
        required: true
      pr_url:
        description: URL of original pull request
        required: true
      pr_title:
        description: Title of original pull request
        required: true
      sha:
        description: SHA of merge commit
        required: true

env:
  BASE_REPOSITORY: shota-kamezawa/base_repository
  TARGET_DIRECTORIES: |
    src/components
    src/pages
    src/utils
    src/middleware
  EXCLUDED_FILES: |
    *.stories.js
    *.mdx

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code ðŸ›Ž
        uses: actions/checkout@main

      - name: Fetch repository
        run: git fetch

      - name: Create epic branch and push it if not exists
        run: git switch ${{ github.event.inputs.epic_branch }} 2> /dev/null || (git switch -c ${{ github.event.inputs.epic_branch }} && git push origin ${{ github.event.inputs.epic_branch }})

      - name: Clone base repository
        uses: actions/checkout@main
        with:
          path: ${{ env.BASE_REPOSITORY }}
          repository: ${{ env.BASE_REPOSITORY }}
          ref: ${{ github.event.inputs.sha }}
          token: ${{ github.token }}

      # FIXME:
      - name: Remove excluded files
        run: for EX_FILE in $EXCLUDED_FILES; do find ${{ env.BASE_REPOSITORY }} -type f -name $EX_FILE -delete -print; done

      # FIXME:
      - name: Remove current directories
        run: for COPY_DIR in $TARGET_DIRECTORIES; do rm -rf $COPY_DIR; done

      # FIXME:
      - name: Move target directories
        run: for COPY_DIR in $TARGET_DIRECTORIES; do mv -v ${{ env.BASE_REPOSITORY }}/$COPY_DIR $COPY_DIR; done

      - name: Remove directory '${{ env.BASE_REPOSITORY }}'
        run: rm -rf ${{ env.BASE_REPOSITORY }}

      - name: Create pull request
        uses: peter-evans/create-pull-request@main
        with:
          author: ${{ github.event.sender.login }} <${{ github.event.sender.id }}+${{ github.event.sender.login }}@users.noreply.github.com>
          branch: ${{ github.event.inputs.epic_branch }}-sync
          branch-suffix: timestamp
          commit-message: ðŸ”„ sync with ${{ env.BASE_REPOSITORY }}/${{ github.event.inputs.sha }}
          delete-branch: true
          base: ${{ github.event.inputs.epic_branch }}
          title: ðŸ”„ ${{ github.event.inputs.pr_title }}
          body: Files copied from ${{ github.event.inputs.pr_url }}
          labels: sync
